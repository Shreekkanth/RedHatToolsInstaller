- hosts: localhost
  vars:
    forklift_name: pipeline-satellite-6.2-rhel7
    forklift_boxes:
      pipeline-satellite-6.2-rhel7:
        box: rhel7
        memory: 4680
      pipeline-capsule-6.2-rhel7:
        box: rhel7
        memory: 3072
  roles:
    - forklift

- hosts: pipeline-satellite-6.2-rhel7
  tasks:
    - set_fact:
        compose_repository_type: Satellite
        activation_key: "rhel{{ ansible_distribution_major_version }}"
        foreman_installer_additional_packages:
          - satellite

- hosts: pipeline-capsule-6.2-rhel7
  tasks:
    - set_fact:
        compose_repository_type: Capsule
        activation_key: "rhel{{ ansible_distribution_major_version }}"
        foreman_installer_additional_packages:
          - satellite-capsule

- hosts:
    - pipeline-satellite-6.2-rhel7
    - pipeline-capsule-6.2-rhel7
  become: yes
  vars:
    satellite_version: 6.2
    compose_repository_version: 6.2
    foreman_installer_skip_installer: true
  roles:
    - etc_hosts
    - register
    - compose-repository
    - update_os_packages
    - foreman_installer

- hosts: pipeline-satellite-6.2-rhel7
  become: yes
  roles:
    - role: foreman_installer
      foreman_installer_scenario: satellite
      foreman_installer_command: satellite-installer
      foreman_installer_options_internal_use_only:
          - "--foreman-admin-password {{ foreman_installer_admin_password }}"
    - role: hammer_config

- hosts: pipeline-capsule-6.2-rhel7
  become: yes
  vars:
    foreman_proxy_content_server: "pipeline-satellite-6.2-rhel7"
    custom_install: True
    capsule_certs_tar: "/root/{{ ansible_nodename }}.tar.gz"
  roles:
    - foreman_proxy_content
    - role: foreman_installer
      foreman_installer_command: satellite-installer
      foreman_installer_scenario: capsule
      foreman_installer_options_internal_use_only:
        - '--foreman-proxy-trusted-hosts "{{ server_fqdn.stdout }}"
          --foreman-proxy-trusted-hosts "{{ ansible_nodename }}"
          --foreman-proxy-foreman-base-url "https://{{ server_fqdn.stdout }}"
          --foreman-proxy-register-in-foreman true
          --foreman-proxy-oauth-consumer-key "{{ oauth_consumer_key.stdout }}"
          --foreman-proxy-oauth-consumer-secret "{{ oauth_consumer_secret.stdout }}"
          --capsule-certs-tar "{{ capsule_certs_tar }}"
          --capsule-parent-fqdn "{{ server_fqdn.stdout }}"
          --capsule-pulp-oauth-secret "{{ pulp_oauth_secret.stdout }}"'

- hosts: pipeline-satellite-6.2-rhel7
  become: yes
  vars:
    bats_tests:
      - fb-test-foreman.bats
      - fb-test-katello.bats
      - fb-finish-katello.bats
  roles:
    - bats
