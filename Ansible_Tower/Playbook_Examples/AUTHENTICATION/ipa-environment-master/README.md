# ipa-environment
This Ansible Playbook deploys a functioning IPA environment.

## Requirements
 This playbook requires some external roles. Before application make sure you import those dependencies.

```shell
make requirements
```
## Deployment Environments
This Ansible environment employs a multi-environment deployment strategy. Each
environment has separate `group_vars` and inventories.
```
.
+-- development
|   +-- group_vars
|   |   +-- all.yml
|   +-- inventory
|   +-- README.md
+-- integration
|   +-- group_vars
|   |   +-- all.yml
|   |   +-- app.yml
|   |   +-- ipa-masters.yml
|   |   +-- ipa-replica.yml
|   |   +-- ipa-server.yml
|   +-- inventory
|   +-- README.md
```
This structure allows for multi-environment variables to exist is external
version control systems.

Calling one of these environments is done by using the `-i ` | ` --inventory-file=`
parameter with `ansible-playbook`. Ansible will search within the specified
directory looking for the `inventory` file.

For example:
```shell
ansible-playbook -i development site.yml
```
Two environments are distributed with this repository, refer to the README.md
that details the nuance of each environment.
* [development](development/README.md)
* [integration](integration/README.md)


### New Environments
Instructions on adding externally hosted environments - [docs/environments.md](docs/environments.md)

## Deployment Plan
`site.yml` defines the role alignment to host groups. Non environment pertinent
variables are also defined here.
When defining variables you can define variables against the host group aka
_Group Variables_ or directly on the role scopes please consider variable precedence when deciding
which scope your variable should exist in.

```yaml
- hosts: ipa-server
  vars:
    ipa_server_enable_ca: true
    ipa_server_enable_dns: false
  roles:
    - role: ipa-server
  ...
```
## Variables Precedence and Insertion
Ansible provide at the time of writing 21 levels of [variable precedence](http://docs.ansible.com/ansible/latest/playbooks_variables.html#variable-precedence-where-should-i-put-a-variable). To simplify the understanding of our variables usage the following table focuses on user configurable variables from lowest to highest priority as they have been used in this playbook.

When determining where a variables should be defined can take some time to figure out. Remember the higher the priority the smaller the scope in which the variable will be available.

|Precedence|type|location|Description|
|-|-|-|-|
| 0 | role defaults | {role}/defaults/main.yml | These are lowest priority variables in the entire playbook. Every variable your role asserts must be defined here in it default context. This elevates variable undefined errors and helps document the role by describing all the configurable variables in a single location. |
|1|role vars|{role}/vars/main.yml| One step about of defaults, this is where you redefine variable to suit your role's use case. For example - If your role executes a command outside of delivered parameter you would define that here.|
|2|include vars|{role}/vars/{ansible_os_family}.yml| Next variables what separate out platform specific differences. For instance - if your role supports multiple operating systems you can callout those differences here. |
|3|inventory file or script group vars|{environment}/inventory| Variables defined in the inventory file with a `[_group_:vars]` block. This is used in low side environments where some variables are generated by the development environment automation. In high side environments where infrastructure is static setting variables should be done through `{environment}/group_vars/*.yml` |
|4|inventory group_vars/all|{environment}/group_vars/all.yml| The lowest priority of all the group_vars that will be administratively defined. We define variables that will differ between deployment environments here. `All` will target all systems in the deployment.|
|5|inventory group_vars/_group_|{environment}/group_vars/_group_.yml| Similar priority to the `all` group_vars though targets the defined hosts of that group.|
|6|playbook group_vars/all|site.yml|These variables are defined in the site playbook itself. Here we define group_vars that are the same aross all deployment environments. For Example - we enable/disable IPA functions at this level to ensure all sites have the same feature set.|
|7|inventory file or script host vars|{environment}/inventory|Similar to precedence 3 though targets specific hosts. This is used in low side environments where ssh connections must use a bastion. Static environments should make use of priority 8 host_vars which are easier to read and maintain.|
|8|inventory host_vars/*|{environment}/host_vars/*.yml|Where `*` is the inventory hostname of the system. Here we call out host specific details such as host certificates and keys.|
|10|role (and include_role) params|site.yml|The highest priority variables defined here will apply across all deployment environments but only accessible from within the single role - use sparingly.|


###  Private Variables
From all the priorities listed above there is one other that should be considered though not user configurable. Variables instantiated through either the `set_fact` module or the `register` method take precedence over any user configured variables. To prevent clashing with user configured variables these variables should be considered private (not user configurable or accessible), and prefixed with the `_` (underscore) character.


## Application
This environment requires a static Ansible inventory to deploy. In lowside
environments infrastructure can be created and inventory automatically created.

The most common deployment method will be a development environment. Running
`make` will deploy development infrastructure in azure.
```shell
make spin
```
The location can also be specified. Default "Australia East"
```shell
make spin LOCATION="Australia Southeast"
```

This will automatically create the Ansible inventory file. Ansible can then
deploy the work in progress configuration with:
```shell
ansible-playbook -i development site.yml
```
Before committing changes it is advisable to clean the environment of build
artefacts. This will also terminate the running development environment.
```shell
make clean
```

Additional make commands can be shown with:
```shell
make help
```

## License
LGPL

## Author Information
Devil Horn Project

maintainer: tdb@tdb.com
JIRA: https://redhat-anzservices.atlassian.net/secure/RapidBoard.jspa?rapidView=7
